<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Focus Space 3D - Ultimate Study</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0f172a;
            --text-color: white;
            --ui-bg: rgba(15, 23, 42, 0.6);
            --note-yellow: #fdfd96;
            --note-blue: #aec6cf;
            --note-pink: #ffb7b2;
            --note-purple: #c7ceea;
            --glass-border: rgba(255, 255, 255, 0.1);
            --rain-opacity: 0;
        }

        /* --- THEMES --- */
        body.theme-light {
            --bg-color: #f0f9ff;
            --text-color: #1e293b;
            --ui-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(0, 0, 0, 0.1);
        }
        body.theme-light .note { box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        body.theme-light #app-title h1 { text-shadow: none; color: #0f172a; }
        body.theme-light #app-title p { color: #64748b; }
        body.theme-light .ui-btn { color: #334155; background: rgba(0,0,0,0.05); }
        body.theme-light .ui-btn:hover { background: rgba(0,0,0,0.1); }
        body.theme-light #viewport { filter: brightness(1.1); }

        body.theme-sad {
            --bg-color: #050505;
            --rain-opacity: 1;
        }
        body.theme-sad #viewport { filter: grayscale(1) contrast(1.2) brightness(0.7); }
        body.theme-sad #bg-canvas { opacity: 0.3; }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            user-select: none;
            -webkit-font-smoothing: antialiased;
            transition: background-color 1s ease, color 0.5s ease;
        }

        /* --- RAIN EFFECT --- */
        #rain-container {
            position: fixed; inset: 0; pointer-events: none; z-index: 5;
            opacity: var(--rain-opacity); transition: opacity 2s;
            background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.2));
        }
        .rain-drop {
            position: absolute; background: rgba(255,255,255,0.2);
            width: 1px; height: 40px; top: -50px;
            animation: fall linear infinite;
        }
        @keyframes fall {
            to { transform: translateY(110vh); }
        }

        /* --- 3D SCENE --- */
        #viewport {
            position: absolute;
            top: 0; left: 0; width: 100vw; height: 100vh;
            perspective: 1200px; /* Deep perspective */
            overflow: hidden;
            z-index: 10;
            pointer-events: none;
        }

        #world {
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            transform-style: preserve-3d;
            pointer-events: auto;
            will-change: transform;
        }

        /* --- STICKY NOTE --- */
        .note {
            position: absolute;
            width: 240px; height: 240px;
            background: var(--note-yellow);
            color: #333;
            padding: 20px;
            box-sizing: border-box;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.4rem;
            line-height: 1.4;
            border-radius: 2px 2px 25px 2px; /* Paper fold effect */
            
            /* Hardware Acceleration */
            transform-style: preserve-3d;
            backface-visibility: hidden;
            will-change: transform, opacity;
            
            /* Visuals */
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            transition: opacity 0.4s ease, box-shadow 0.3s ease, filter 0.4s ease, transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            
            display: flex;
            flex-direction: column;
            cursor: grab;
            
            /* Float Animation via CSS for performance */
            animation: floatNode 6s ease-in-out infinite;
            animation-delay: calc(var(--delay) * -1s);
        }

        @keyframes floatNode {
            0%, 100% { margin-top: 0px; }
            50% { margin-top: -15px; }
        }

        /* Note States */
        .note.active-drag {
            cursor: grabbing;
            z-index: 10000 !important;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            transition: none !important; /* Instant follow */
            animation: none;
        }

        .note.pinned {
            animation: none;
            border-top: 4px solid rgba(0,0,0,0.2);
        }

        .note.important {
            box-shadow: 0 0 40px var(--glow-color, rgba(255,255,100,0.6));
            z-index: 5000;
            border: 2px solid white;
        }

        .note.focused {
            z-index: 9999 !important;
            transform: translate3d(0, 0, 400px) rotateX(0) rotateY(0) rotateZ(0) !important;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
            pointer-events: auto !important;
        }

        .note.blurred {
            opacity: 0.2;
            filter: blur(4px);
            pointer-events: none;
        }

        .note:hover {
            z-index: 1000;
        }

        .note textarea {
            width: 100%; height: 100%;
            background: transparent; border: none;
            resize: none; outline: none;
            font-family: inherit; font-size: inherit; color: inherit;
            cursor: text;
        }

        /* --- CONTROLS ON NOTE --- */
        .note-controls {
            position: absolute; top: -15px; right: -10px;
            display: flex; gap: 4px;
            opacity: 0; transition: opacity 0.2s;
            transform: translateZ(20px); /* Floating above note */
        }
        .note:hover .note-controls, .note.focused .note-controls { opacity: 1; }

        .n-btn {
            width: 28px; height: 28px;
            background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.2s;
            color: #444;
        }
        .n-btn:hover { transform: scale(1.1); }
        .n-btn.delete:hover { background: #fee2e2; color: #ef4444; }
        .n-btn.focus:hover { background: #e0f2fe; color: #0ea5e9; }
        .n-btn.star.active { color: #eab308; background: #fef9c3; }

        /* --- TIMER 3D --- */
        #timer-card {
            background: #1e293b;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid rgba(255,255,255,0.1);
            display: none; /* Hidden by default */
            align-items: center; justify-content: center;
            flex-direction: column;
        }
        #timer-display { font-size: 3rem; font-weight: 700; letter-spacing: 2px; }

        /* --- UI OVERLAY --- */
        #ui-layer {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            display: flex; gap: 12px;
            z-index: 100;
            padding: 10px 20px;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: opacity 0.5s;
        }

        .ui-btn {
            width: 44px; height: 44px;
            border-radius: 12px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white; font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .ui-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
        .ui-btn:active { transform: scale(0.95); }
        
        .ui-tooltip {
            position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 4px 8px;
            border-radius: 4px; font-size: 12px; opacity: 0; pointer-events: none;
            transition: opacity 0.2s; white-space: nowrap;
        }
        .ui-btn:hover .ui-tooltip { opacity: 1; }

        /* --- PROMISE CARD --- */
        #promise-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            z-index: 200;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s;
        }
        #promise-overlay.active { opacity: 1; pointer-events: auto; }
        
        /* Low End Mode Optimizations */
        body.low-end .note {
            box-shadow: none !important; /* Remove shadows */
            transition: transform 0.1s !important; /* Faster transition */
            animation: none !important; /* No floating */
        }
        body.low-end #bg-canvas {
            display: none; /* Disable WebGL stars */
        }
        
        /* Zen Mode */
        body.zen #ui-layer { opacity: 0; pointer-events: none; }
        body.zen #app-title { opacity: 0.1; }

    </style>
</head>
<body>

    <!-- WebGL Background -->
    <canvas id="bg-canvas"></canvas>

    <!-- 3D World -->
    <div id="viewport">
        <div id="world">
            <!-- Notes injected here -->
            
            <!-- 3D Timer Object -->
            <div id="timer-card" class="note" style="background: #1e293b; width: 300px; height: 160px; z-index: 100;">
                <h3 class="text-gray-400 text-sm mb-2 uppercase tracking-widest">Focus Timer</h3>
                <div id="timer-display">25:00</div>
                <div class="flex gap-4 mt-4">
                    <button id="timer-start" class="px-4 py-1 bg-emerald-600 rounded hover:bg-emerald-500 text-sm font-sans">Start</button>
                    <button id="timer-reset" class="px-4 py-1 bg-slate-600 rounded hover:bg-slate-500 text-sm font-sans">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- UI Controls -->
    <div id="ui-layer">
        <button class="ui-btn" id="btn-add" style="background: rgba(255,255,255,0.2)">
            üìù<span class="ui-tooltip">Th√™m Note</span>
        </button>
        <div class="w-[1px] h-8 bg-white/10 mx-1"></div>
        <button class="ui-btn" id="btn-group">
            üß©<span class="ui-tooltip">X·∫øp theo m√¥n</span>
        </button>
        <button class="ui-btn" id="btn-timer">
            ‚è≥<span class="ui-tooltip">B·∫≠t Timer</span>
        </button>
        <button class="ui-btn" id="btn-focus">
            üéØ<span class="ui-tooltip">Reset Camera</span>
        </button>
        <div class="w-[1px] h-8 bg-white/10 mx-1"></div>
        <button class="ui-btn" id="btn-music">
            üéß<span class="ui-tooltip">B·∫≠t/T·∫Øt Nh·∫°c</span>
        </button>
        <button class="ui-btn" id="btn-upload" onclick="document.getElementById('audio-input').click()">
            üìÇ<span class="ui-tooltip">File Nh·∫°c C·ªßa B·∫°n</span>
        </button>
        <div class="w-[1px] h-8 bg-white/10 mx-1"></div>
        <button class="ui-btn" id="btn-theme-light">
            ‚òÄÔ∏è<span class="ui-tooltip">S√°ng</span>
        </button>
        <button class="ui-btn" id="btn-theme-sad">
            üíî<span class="ui-tooltip">Th·∫•t T√¨nh</span>
        </button>
        <button class="ui-btn" id="btn-lowend">
            ‚ö°<span class="ui-tooltip">M√°y Y·∫øu</span>
        </button>
        <button class="ui-btn" id="btn-zen">
            üçÉ<span class="ui-tooltip">Zen</span>
        </button>
    </div>

    <!-- Hidden Inputs/Containers -->
    <input type="file" id="audio-input" accept="audio/*" style="display: none;">
    <div id="rain-container"></div>

    <!-- App Title -->
    <div id="app-title" class="fixed top-6 left-8 z-50 pointer-events-none transition-opacity duration-500">
        <h1 class="text-3xl font-bold text-white tracking-widest font-sans drop-shadow-lg">FOCUS SPACE</h1>
        <p class="text-sm text-blue-200">G√≥c √¥n thi 3D</p>
    </div>

    <!-- Promise Overlay -->
    <div id="promise-overlay">
        <div class="bg-white rounded-lg p-8 w-[500px] text-center shadow-2xl transform scale-100">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 font-sans">‚ú® L·ªùi H·ª©a M√πa Thi ‚ú®</h2>
            <textarea id="promise-text" class="w-full h-32 p-4 bg-slate-50 rounded border border-slate-200 resize-none mb-4 font-hand text-xl" placeholder="Thi xong tui s·∫Ω..."></textarea>
            <div class="flex justify-center gap-4">
                <button id="btn-save-promise" class="px-6 py-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700">Quy·∫øt t√¢m!</button>
                <button id="btn-close-promise" class="px-6 py-2 text-slate-500 hover:text-slate-700">ƒê·ªÉ sau</button>
            </div>
        </div>
    </div>

    <!-- Audio -->
    <audio id="bg-audio" loop preload="auto">
        <source src="https://cdn.pixabay.com/download/audio/2022/08/02/audio_884fe92c21.mp3?filename=relaxing-music-vol1-124477.mp3" type="audio/mpeg">
    </audio>

    <script>
        /**
         * SENIOR DEV ARCHITECTURE
         * 1. State Management: Centralized store for notes and settings.
         * 2. Loop Optimization: Single requestAnimationFrame.
         * 3. Performance: CSS transforms for heavy lifting, JS for logic.
         */

        const CONFIG = {
            colors: ['bg-yellow', 'bg-blue', 'bg-pink', 'bg-purple'], // Tailwind classes handled in CSS var
            colorMap: {
                'bg-yellow': '#fdfd96',
                'bg-blue': '#aec6cf',
                'bg-pink': '#ffb7b2',
                'bg-purple': '#c7ceea'
            },
            maxPixelRatio: Math.min(window.devicePixelRatio, 2),
            rotationSpeed: 0.05
        };

        const STATE = {
            notes: [],
            mode: 'orbit', // orbit, drag, focus
            isLowEnd: false,
            isZen: false,
            focusedNoteId: null,
            mouse: { x: 0, y: 0 },
            targetRot: { x: 0, y: 0 },
            currRot: { x: 0, y: 0 },
            drag: { active: false, id: null, offset: {x:0, y:0}, startPos: {x:0, y:0} },
            timer: { active: false, time: 25 * 60, interval: null }
        };

        const DOM = {
            world: document.getElementById('world'),
            ui: document.getElementById('ui-layer'),
            audio: document.getElementById('bg-audio'),
            timerCard: document.getElementById('timer-card'),
            timerDisplay: document.getElementById('timer-display')
        };

        // --- 1. CORE RENDER LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            // Smooth Rotation (Lerp)
            // Only rotate if not dragging and not focused
            if (!STATE.drag.active && STATE.mode === 'orbit') {
                STATE.currRot.x += (STATE.mouse.y * 5 - STATE.currRot.x) * CONFIG.rotationSpeed;
                STATE.currRot.y += (STATE.mouse.x * 5 - STATE.currRot.y) * CONFIG.rotationSpeed;
            } else if (STATE.mode === 'focus') {
                // Return to center when focused
                STATE.currRot.x += (0 - STATE.currRot.x) * 0.1;
                STATE.currRot.y += (0 - STATE.currRot.y) * 0.1;
            }

            DOM.world.style.transform = `rotateX(${STATE.currRot.x.toFixed(2)}deg) rotateY(${STATE.currRot.y.toFixed(2)}deg)`;
            
            // Render Stars if not low-end
            if (!STATE.isLowEnd && ThreeApp.renderer) {
                ThreeApp.render();
            }
        }

        // --- 2. NOTE MANAGER ---
        const NoteManager = {
            init() {
                const saved = localStorage.getItem('fs-notes');
                if (saved) {
                    STATE.notes = JSON.parse(saved);
                    STATE.notes.forEach(n => this.render(n));
                } else {
                    // Welcome notes
                    this.add("Ch√†o b·∫°n! üëã\nƒê√¢y l√† kh√¥ng gian t·∫≠p trung.", {x: -200, y: -100, z: 0, color: 'bg-yellow'});
                    this.add("B·∫•m üéØ ƒë·ªÉ focus.\nB·∫•m ‚≠ê ƒë·ªÉ ƒë√°nh d·∫•u.", {x: 200, y: 50, z: -100, color: 'bg-blue'});
                }
            },

            add(content = '', pos = null) {
                const note = {
                    id: Date.now(),
                    content,
                    color: CONFIG.colors[Math.floor(Math.random() * CONFIG.colors.length)],
                    x: pos ? pos.x : (Math.random() - 0.5) * 800,
                    y: pos ? pos.y : (Math.random() - 0.5) * 400,
                    z: pos ? pos.z : (Math.random() * -600),
                    pinned: false,
                    important: false
                };
                if(pos && pos.color) note.color = pos.color;

                STATE.notes.push(note);
                this.render(note);
                this.save();
            },

            render(data) {
                const el = document.createElement('div');
                el.className = `note ${data.pinned ? 'pinned' : ''} ${data.important ? 'important' : ''}`;
                el.id = `n-${data.id}`;
                el.dataset.id = data.id;
                el.style.setProperty('--delay', Math.random() * 5); // Random float delay
                el.style.setProperty('--bg-color', CONFIG.colorMap[data.color]);
                el.style.backgroundColor = CONFIG.colorMap[data.color];
                if(data.important) el.style.setProperty('--glow-color', CONFIG.colorMap[data.color]);

                el.style.transform = `translate3d(${data.x}px, ${data.y}px, ${data.z}px)`;

                el.innerHTML = `
                    <div class="note-controls">
                        <div class="n-btn focus" title="Focus">üéØ</div>
                        <div class="n-btn star ${data.important ? 'active' : ''}" title="Quan tr·ªçng">‚≠ê</div>
                        <div class="n-btn delete" title="X√≥a">√ó</div>
                    </div>
                    <div class="pin-icon absolute -top-3 left-1/2 -translate-x-1/2 text-2xl ${data.pinned ? '' : 'hidden'}">üìå</div>
                    <textarea spellcheck="false" placeholder="Vi·∫øt g√¨ ƒë√≥...">${data.content}</textarea>
                `;

                DOM.world.appendChild(el);
            },

            update(id, updates) {
                const note = STATE.notes.find(n => n.id === id);
                if (!note) return;
                Object.assign(note, updates);
                
                const el = document.getElementById(`n-${id}`);
                if (el) {
                    if (updates.hasOwnProperty('x')) {
                        el.style.transform = `translate3d(${note.x}px, ${note.y}px, ${note.z}px)`;
                    }
                    if (updates.pinned !== undefined) {
                        el.classList.toggle('pinned', note.pinned);
                        el.querySelector('.pin-icon').classList.toggle('hidden', !note.pinned);
                    }
                    if (updates.important !== undefined) {
                        el.classList.toggle('important', note.important);
                        el.querySelector('.n-btn.star').classList.toggle('active', note.important);
                    }
                }
                this.save();
            },

            delete(id) {
                const el = document.getElementById(`n-${id}`);
                if(el) {
                    el.style.transform += ' scale(0)';
                    el.style.opacity = '0';
                    setTimeout(() => el.remove(), 300);
                }
                STATE.notes = STATE.notes.filter(n => n.id !== id);
                this.save();
            },

            save() {
                localStorage.setItem('fs-notes', JSON.stringify(STATE.notes));
            },
            
            groupNotes() {
                // Arrange by color: Left (Yellow), Center (Blue), Right (Pink/Purple)
                STATE.notes.forEach(n => {
                    let targetX = 0;
                    if (n.color === 'bg-yellow') targetX = -400;
                    else if (n.color === 'bg-blue') targetX = 0;
                    else targetX = 400;
                    
                    // Animate to new position
                    n.x = targetX + (Math.random() - 0.5) * 200;
                    n.y = (Math.random() - 0.5) * 400;
                    n.z = (Math.random() * -400); // Flatten Z a bit
                    
                    this.update(n.id, { x: n.x, y: n.y, z: n.z });
                });
            }
        };

        // --- 3. INTERACTION MANAGER ---
        const Interaction = {
            init() {
                window.addEventListener('mousemove', e => {
                    STATE.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                    STATE.mouse.y = (e.clientY / window.innerHeight) * 2 - 1;
                    this.handleDrag(e);
                });
                
                window.addEventListener('mouseup', () => {
                    if (STATE.drag.active) {
                        const el = document.getElementById(`n-${STATE.drag.id}`);
                        if(el) el.classList.remove('active-drag');
                        STATE.drag.active = false;
                        NoteManager.save(); // Save position after drag
                    }
                });

                DOM.world.addEventListener('mousedown', this.onWorldClick.bind(this));
                DOM.world.addEventListener('click', this.onControlsClick.bind(this));
                DOM.world.addEventListener('input', this.onInput.bind(this)); // Auto save text

                // UI Buttons
                document.getElementById('btn-add').onclick = () => NoteManager.add();
                document.getElementById('btn-group').onclick = () => NoteManager.groupNotes();
                document.getElementById('btn-focus').onclick = () => this.exitFocus();
                document.getElementById('btn-timer').onclick = () => Timer.toggle();
                document.getElementById('btn-lowend').onclick = this.toggleLowEnd.bind(this);
                document.getElementById('btn-zen').onclick = this.toggleZen.bind(this);
                document.getElementById('btn-music').onclick = this.toggleMusic.bind(this);
                
                // New Features
                document.getElementById('btn-theme-light').onclick = () => {
                    this.setTheme(document.body.classList.contains('theme-light') ? 'dark' : 'light');
                };
                document.getElementById('btn-theme-sad').onclick = () => {
                    this.setTheme(document.body.classList.contains('theme-sad') ? 'dark' : 'sad');
                };
                document.getElementById('audio-input').addEventListener('change', this.handleAudioUpload);
            },

            onWorldClick(e) {
                if (STATE.mode === 'focus') return; // No drag in focus mode
                
                const noteEl = e.target.closest('.note');
                const isControl = e.target.closest('.note-controls') || e.target.tagName === 'BUTTON';
                
                if (noteEl && !isControl && noteEl.id !== 'timer-card') {
                    const id = parseInt(noteEl.dataset.id);
                    const note = STATE.notes.find(n => n.id === id);
                    
                    if (note) {
                        STATE.drag.active = true;
                        STATE.drag.id = id;
                        STATE.drag.startPos = { x: e.clientX, y: e.clientY };
                        STATE.drag.offset = { x: note.x, y: note.y }; // Store initial logic pos
                        noteEl.classList.add('active-drag');
                    }
                }
            },

            handleDrag(e) {
                if (STATE.drag.active) {
                    const deltaX = (e.clientX - STATE.drag.startPos.x) * 1.5; // Sensitivity
                    const deltaY = (e.clientY - STATE.drag.startPos.y) * 1.5;
                    
                    const note = STATE.notes.find(n => n.id === STATE.drag.id);
                    if(note) {
                        note.x = STATE.drag.offset.x + deltaX;
                        note.y = STATE.drag.offset.y + deltaY;
                        
                        // Direct update for smoothness
                        const el = document.getElementById(`n-${STATE.drag.id}`);
                        el.style.transform = `translate3d(${note.x}px, ${note.y}px, ${note.z}px)`;
                    }
                }
            },

            onControlsClick(e) {
                const btn = e.target.closest('.n-btn');
                if (!btn) return;
                
                const noteEl = e.target.closest('.note');
                const id = parseInt(noteEl.dataset.id);
                
                if (btn.classList.contains('delete')) NoteManager.delete(id);
                if (btn.classList.contains('star')) {
                    const note = STATE.notes.find(n => n.id === id);
                    NoteManager.update(id, { important: !note.important });
                }
                if (btn.classList.contains('focus')) this.enterFocus(id);
            },

            // --- THEME MANAGER ---
            setTheme(mode) {
                document.body.classList.remove('theme-light', 'theme-sad');
                
                if (mode === 'light') {
                    document.body.classList.add('theme-light');
                    if(ThreeApp.scene) ThreeApp.scene.fog.color.setHex(0xf0f9ff);
                } else if (mode === 'sad') {
                    document.body.classList.add('theme-sad');
                    if(ThreeApp.scene) ThreeApp.scene.fog.color.setHex(0x050505);
                    this.createRain();
                } else {
                    // Default Dark
                    if(ThreeApp.scene) ThreeApp.scene.fog.color.setHex(0x0f172a);
                }
            },

            createRain() {
                const container = document.getElementById('rain-container');
                if(container.childElementCount > 0) return; // Already created
                
                for(let i=0; i<50; i++) {
                    const drop = document.createElement('div');
                    drop.className = 'rain-drop';
                    drop.style.left = Math.random() * 100 + 'vw';
                    drop.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
                    drop.style.animationDelay = Math.random() * 2 + 's';
                    container.appendChild(drop);
                }
            },

            handleAudioUpload(e) {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    DOM.audio.src = url;
                    DOM.audio.play();
                    document.getElementById('btn-music').style.color = '#f472b6';
                    document.getElementById('btn-music').innerHTML = 'üéº';
                    alert(`ƒêang ph√°t: ${file.name}`);
                }
            },
            
            onInput(e) {
                if(e.target.tagName === 'TEXTAREA') {
                    const id = parseInt(e.target.closest('.note').dataset.id);
                    const note = STATE.notes.find(n => n.id === id);
                    if(note) {
                        note.content = e.target.value;
                        NoteManager.save();
                    }
                }
            },

            enterFocus(id) {
                STATE.mode = 'focus';
                STATE.focusedNoteId = id;
                
                const allNotes = document.querySelectorAll('.note');
                allNotes.forEach(el => {
                    if (parseInt(el.dataset.id) === id) {
                        el.classList.add('focused');
                    } else {
                        el.classList.add('blurred');
                    }
                });
                
                document.getElementById('btn-focus').style.background = '#0ea5e9'; // Highlight UI
            },

            exitFocus() {
                STATE.mode = 'orbit';
                STATE.focusedNoteId = null;
                
                const allNotes = document.querySelectorAll('.note');
                allNotes.forEach(el => {
                    el.classList.remove('focused', 'blurred');
                });
                
                document.getElementById('btn-focus').style.background = '';
            },
            
            toggleLowEnd() {
                STATE.isLowEnd = !STATE.isLowEnd;
                document.body.classList.toggle('low-end', STATE.isLowEnd);
                const btn = document.getElementById('btn-lowend');
                btn.style.color = STATE.isLowEnd ? '#eab308' : 'white';
                if(STATE.isLowEnd) alert("ƒê√£ b·∫≠t ch·∫ø ƒë·ªô m√°y y·∫øu: T·∫Øt sao n·ªÅn, b√≥ng ƒë·ªï v√† animation.");
            },
            
            toggleZen() {
                STATE.isZen = !STATE.isZen;
                document.body.classList.toggle('zen', STATE.isZen);
            },
            
            toggleMusic() {
                if (DOM.audio.paused) {
                    DOM.audio.play().then(() => {
                        document.getElementById('btn-music').style.color = '#f472b6';
                    }).catch(err => {
                        console.log(err);
                        alert("Tr√¨nh duy·ªát ch·∫∑n t·ª± ph√°t nh·∫°c. Vui l√≤ng click l·∫°i l·∫ßn n·ªØa!");
                    });
                } else {
                    DOM.audio.pause();
                    document.getElementById('btn-music').style.color = 'white';
                }
            }
        };

        // --- 4. TIMER ---
        const Timer = {
            toggle() {
                if (DOM.timerCard.style.display === 'flex') {
                    DOM.timerCard.style.display = 'none';
                } else {
                    DOM.timerCard.style.display = 'flex';
                    // Reset position to center
                    DOM.timerCard.style.transform = 'translate3d(0,0,100px)';
                }
            },
            start() {
                if (STATE.timer.interval) return;
                STATE.timer.active = true;
                STATE.timer.interval = setInterval(() => {
                    STATE.timer.time--;
                    this.updateDisplay();
                    if (STATE.timer.time <= 0) {
                        this.stop();
                        alert("H·∫øt gi·ªù h·ªçc! Ngh·ªâ ng∆°i x√≠u nh√© üåø");
                    }
                }, 1000);
            },
            stop() {
                clearInterval(STATE.timer.interval);
                STATE.timer.interval = null;
                STATE.timer.active = false;
            },
            reset() {
                this.stop();
                STATE.timer.time = 25 * 60;
                this.updateDisplay();
            },
            updateDisplay() {
                const m = Math.floor(STATE.timer.time / 60).toString().padStart(2, '0');
                const s = (STATE.timer.time % 60).toString().padStart(2, '0');
                DOM.timerDisplay.textContent = `${m}:${s}`;
            }
        };
        
        document.getElementById('timer-start').onclick = () => Timer.start();
        document.getElementById('timer-reset').onclick = () => Timer.reset();

        // --- 5. THREE.JS BACKGROUND ---
        const ThreeApp = {
            renderer: null, scene: null, camera: null, stars: null,
            init() {
                const canvas = document.getElementById('bg-canvas');
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x0f172a, 0.001);
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.camera.position.z = 100;

                this.renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: false });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(CONFIG.maxPixelRatio);

                // Create Stars
                const geo = new THREE.BufferGeometry();
                const pos = [];
                for(let i=0; i<2000; i++) {
                    pos.push((Math.random()-0.5)*1000, (Math.random()-0.5)*1000, (Math.random()-0.5)*1000);
                }
                geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
                
                // Optimized Material
                const mat = new THREE.PointsMaterial({ color: 0xffffff, size: 1.5, transparent: true, opacity: 0.8 });
                this.stars = new THREE.Points(geo, mat);
                this.scene.add(this.stars);

                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth/window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            },
            render() {
                if(this.stars) {
                    this.stars.rotation.y += 0.0002;
                    this.stars.rotation.x += 0.0001;
                }
                this.renderer.render(this.scene, this.camera);
            }
        };

        // --- INIT ---
        window.onload = () => {
            ThreeApp.init();
            NoteManager.init();
            Interaction.init();
            animate();
            
            // Set initial volume
            DOM.audio.volume = 0.5;
        };
    </script>
</body>
</html>